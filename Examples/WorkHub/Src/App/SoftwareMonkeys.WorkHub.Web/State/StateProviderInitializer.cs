/*

====================================================================================================

This file as been imported by the Commander console and the 'Import files' script.

The source of the import is:
C:\Projects\SoftwareMonkeys\SiteStarter\Src\App\SoftwareMonkeys.SiteStarter.Web\State\StateProviderInitializer.cs

Do not edit this file or changes may be lost. Edit the source file and the changes will be imported by all projects that use it.

====================================================================================================


*/

using System;
using System.Configuration;
using System.Configuration.Provider;
using System.Web;
using System.Web.Configuration;
using SoftwareMonkeys.WorkHub.State;
using SoftwareMonkeys.WorkHub.Diagnostics;
using SoftwareMonkeys.WorkHub.Entities;

namespace SoftwareMonkeys.WorkHub.Web.State
{
	public class StateProviderInitializer
	{
		private static bool isInitialized = false;
		private static Exception initializationException;

		private static object initializationLock = new object();

		static StateProviderInitializer()
		{
			Initialize();
		}

		/// <summary>
		/// Initializes the application state provider, including virtual server state.
		/// </summary>
		public static void Initialize()
		{
			if (!isInitialized && !StateAccess.IsInitialized)
			{
				InitializeApplicationState();

				isInitialized = true;

			}
		}
		
		/// <summary>
		/// Initializes the managed application and session state.
		/// </summary>
		private static void InitializeApplicationState()
		{
			
			try
			{
				//Get the feature's configuration info
				StateProviderConfiguration qc =
					(StateProviderConfiguration)ConfigurationManager.GetSection("StateProvider");

				if (qc.DefaultProvider == null || qc.Providers == null || qc.Providers.Count < 1)
					throw new ProviderException("You must specify a valid default provider.");

				//Instantiate the providers
				providerCollection = new StateProviderCollection();
				ProvidersHelper.InstantiateProviders(qc.Providers, providerCollection, typeof(BaseStateProvider));
				providerCollection.SetReadOnly();
				defaultProvider = providerCollection[qc.DefaultProvider];
				
				if (HttpContext.Current != null && HttpContext.Current.Request != null)
				{
					defaultProvider.ApplicationPath = HttpContext.Current.Request.ApplicationPath;
					defaultProvider.PhysicalApplicationPath = HttpContext.Current.Server.MapPath(HttpContext.Current.Request.ApplicationPath);
				}
				
				if (defaultProvider == null)
				{
					throw new ConfigurationErrorsException(
						"You must specify a default provider for the feature.",
						qc.ElementInformation.Properties["defaultProvider"].Source,
						qc.ElementInformation.Properties["defaultProvider"].LineNumber);
				}
				
				StateAccess.State = defaultProvider;
			}
			catch (Exception ex)
			{
				initializationException = ex;
				isInitialized = false;
				throw ex;
			}
		}

		//Public feature API
		private static BaseStateProvider defaultProvider;
		private static StateProviderCollection providerCollection;

		public static BaseStateProvider Provider
		{
			get
			{
				return defaultProvider;
			}
		}

		public static StateProviderCollection Providers
		{
			get
			{
				return providerCollection;
			}
		}

	}
}
